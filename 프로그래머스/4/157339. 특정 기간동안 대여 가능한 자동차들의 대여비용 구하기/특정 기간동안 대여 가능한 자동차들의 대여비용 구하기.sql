-- '세단' 또는 'SUV'
-- 2022년 11월 1일부터 2022년 11월 30일까지 대여 가능한 차
-- 대여 금액이 50만원 이상 200만원 미만인 자동차
-- 자동차 ID, 자동차 종류, 대여 금액(컬럼명: FEE) 

WITH RENTAL_CAR AS (
    SELECT CAR_ID, CAR_TYPE, DAILY_FEE, OPTIONS
    FROM CAR_RENTAL_COMPANY_CAR
    WHERE CAR_TYPE IN ('세단', 'SUV') AND NOT CAR_ID IN (
        SELECT CAR_ID
        FROM CAR_RENTAL_COMPANY_RENTAL_HISTORY
        WHERE NOT (END_DATE < '2022-11-01' OR '2022-11-30' < START_DATE)
    )
)
SELECT CAR_ID, CAR_TYPE, TRUNCATE(DAILY_FEE * (
    SELECT 1-DISCOUNT_RATE/100
    FROM CAR_RENTAL_COMPANY_DISCOUNT_PLAN
    WHERE R.CAR_TYPE = CAR_TYPE AND DURATION_TYPE LIKE '30%'
), 0) * 30 AS FEE
FROM RENTAL_CAR R
GROUP BY CAR_ID HAVING 500000 <= FEE AND FEE < 2000000
ORDER BY FEE DESC, CAR_TYPE ASC, CAR_ID DESC
;